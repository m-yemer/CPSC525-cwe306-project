
# Sanity check to make sure the exploit fix works
# Calls fixed.delete_all_tasks_fixed() WITHOUT authentication.

import sys
import os

sys.path.insert(0, os.path.abspath("."))

try:
    from app import fixed, storage, maintenance
except Exception as e:
    print("Failed to import modules from 'app'. Make sure exploit_fixed.py is in the repo root.")
    raise

def main():
    print("== Running CWE-306 exploit against FIXED version: attempt to delete ALL tasks with no authentication ==\n")

    # Generate the sample data
    maintenance.generate_sample_data(5,3)
    tasks = storage.load_tasks()
    print(f"[+] Before exploit, number of tasks: {len(tasks)}")

    # Attempt to trigger the fixed function
    print("[+] Calling fixed.delete_all_tasks_fixed(None) ...")
    ok = fixed.delete_all_tasks_fixed(None)

    # Verify results
    tasks = storage.load_tasks()
    print(f"[+] After exploit, number of tasks: {len(tasks)} (should remain unchanged)")
    print(f"[+] Function returned: {ok}")

    print("Exploit attempt completed.")

if __name__ == "__main__":
    main()
